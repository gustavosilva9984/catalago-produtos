<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Produtos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        header {
            background-color: #000;
            color: #fff;
            padding: 10px 20px;
            text-align: center;
        }
        #categoryFilter {
            text-align: center;
            margin: 20px;
        }
        #productCards {
            padding: 20px;
        }
        .category-container {
            margin-bottom: 40px;
        }
        .category-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        .cards-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 250px;
            display: flex;
            flex-direction: column;
            text-align: center;
            position: relative;
        }
        .card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            cursor: pointer;
        }
        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 15px;
        }
        .card h2 {
            margin: 0;
            font-size: 18px;
        }
        .card p {
            margin: 5px 0;
            font-size: 14px;
        }
        .out-of-stock {
            position: absolute;
            top: 0;
            left: 0;
            background-color: red;
            color: white;
            padding: 5px;
            border-radius: 0 0 8px 0;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 12px;
            z-index: 10;
            display: inline-block;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal img {
            max-width: 90%;
            max-height: 80%;
            object-fit: contain;
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 20px;
            color: #000;
            text-align: center;
            line-height: 30px;
        }
        footer {
            text-align: center;
            padding: 20px;
            background: #fff;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <header>
        <h1>Catálogo de Produtos</h1>
    </header>
    <div id="categoryFilter">
        <label for="categorySelect">Selecione a Categoria:</label>
        <select id="categorySelect" onchange="filterByCategory()">
            <option value="all">Todos</option>
            <!-- Categorias serão adicionadas dinamicamente -->
        </select>
    </div>
    <main id="productCards">
        <!-- Cards serão inseridos aqui -->
    </main>

    <!-- Modal -->
    <div id="modal" class="modal">
        <button class="modal-close" onclick="closeModal()">×</button>
        <img id="modalImage" src="" alt="Imagem Ampliada">
    </div>

    <!-- Rodapé -->
    <footer>
        <button id="downloadPdfBtn">Baixar PDF</button>
        <select id="pdfCategorySelect">
            <option value="all">Todos</option>
            <!-- Categorias serão adicionadas dinamicamente -->
        </select>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const sheetId = '1ZYrDtuedrBwE_QIP_TEVGWcbxSdBO9PDw_FPFokiy5A';  // ID da Planilha
        const apiKey = 'AIzaSyCqjQ-BXCnlCnHTAJbqWH0hl8fj66s5keo';  // Substitua com sua chave de API
        const range = 'Página1';  // Nome da aba ou Range
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;

        let products = [];
        let categories = new Set();

        function fetchData() {
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro na resposta da API: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.values || data.values.length === 0) {
                        throw new Error('Nenhum dado encontrado na planilha.');
                    }
                    
                    const values = data.values;
                    const headers = values[0];
                    const rows = values.slice(1);
                    
                    products = rows.map(row => {
                        let obj = {};
                        row.forEach((value, index) => {
                            obj[headers[index]] = value;
                            if (headers[index] === 'Categoria') {
                                categories.add(value);
                            }
                        });
                        return obj;
                    });

                    populateCategoryFilter();
                    populatePdfCategorySelect();
                    displayCards();  // Exibe todos os produtos inicialmente
                })
                .catch(error => console.error('Erro ao carregar a planilha:', error));
        }

        function populateCategoryFilter() {
            const categorySelect = document.getElementById('categorySelect');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }

        function populatePdfCategorySelect() {
            const pdfCategorySelect = document.getElementById('pdfCategorySelect');
            pdfCategorySelect.innerHTML = '<option value="all">Todos</option>';

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                pdfCategorySelect.appendChild(option);
            });
        }

        function displayCards() {
            const productCards = document.getElementById('productCards');
            productCards.innerHTML = '';
            
            // Cria um container para cada categoria
            const categoriesArray = Array.from(categories);
            categoriesArray.forEach(category => {
                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'category-container';

                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.textContent = category;
                categoryContainer.appendChild(categoryTitle);

                const cardsRow = document.createElement('div');
                cardsRow.className = 'cards-row';
                categoryContainer.appendChild(cardsRow);

                const filteredProducts = products.filter(product => product['Categoria'] === category);

                filteredProducts.forEach(row => {
                    const productName = row['Produtos'];  // Nome do produto
                    const productStock = row['Estoque'];  // Quantidade em estoque
                    const productCode = row['Código'];    // Código do produto
                    const productImageURL = row['Imagem']; // URL da imagem

                    if (productName) {
                        const card = document.createElement('div');
                        card.className = 'card';

                        // Verifica se o estoque é zero
                        if (productStock.trim() === '0') {
                            const outOfStockTag = document.createElement('div');
                            outOfStockTag.className = 'out-of-stock';
                            outOfStockTag.innerText = 'Sem Estoque';
                            card.appendChild(outOfStockTag);
                        }

                        card.innerHTML += `
                            <img src="${productImageURL}" alt="Imagem de ${productName}" onclick="openModal('${productImageURL}')">
                            <div class="card-content">
                                <h2>${productName}</h2>
                                <p>Estoque: ${productStock}</p>
                                <p>Código: ${productCode}</p>
                            </div>
                        `;

                        cardsRow.appendChild(card);
                    }
                });

                productCards.appendChild(categoryContainer);
            });
        }

        function filterByCategory() {
            const categorySelect = document.getElementById('categorySelect');
            const selectedCategory = categorySelect.value;
            
            if (selectedCategory === 'all') {
                displayCards();
            } else {
                const productCards = document.getElementById('productCards');
                productCards.innerHTML = '';

                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'category-container';

                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.textContent = selectedCategory;
                categoryContainer.appendChild(categoryTitle);

                const cardsRow = document.createElement('div');
                cardsRow.className = 'cards-row';
                categoryContainer.appendChild(cardsRow);

                const filteredProducts = products.filter(product => product['Categoria'] === selectedCategory);

                filteredProducts.forEach(row => {
                    const productName = row['Produtos'];  // Nome do produto
                    const productStock = row['Estoque'];  // Quantidade em estoque
                    const productCode = row['Código'];    // Código do produto
                    const productImageURL = row['Imagem']; // URL da imagem

                    if (productName) {
                        const card = document.createElement('div');
                        card.className = 'card';

                        // Verifica se o estoque é zero
                        if (productStock.trim() === '0') {
                            const outOfStockTag = document.createElement('div');
                            outOfStockTag.className = 'out-of-stock';
                            outOfStockTag.innerText = 'Sem Estoque';
                            card.appendChild(outOfStockTag);
                        }

                        card.innerHTML += `
                            <img src="${productImageURL}" alt="Imagem de ${productName}" onclick="openModal('${productImageURL}')">
                            <div class="card-content">
                                <h2>${productName}</h2>
                                <p>Estoque: ${productStock}</p>
                                <p>Código: ${productCode}</p>
                            </div>
                        `;

                        cardsRow.appendChild(card);
                    }
                });

                productCards.appendChild(categoryContainer);
            }
        }

        function openModal(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        document.getElementById('downloadPdfBtn').addEventListener('click', () => {
            const selectedCategory = document.getElementById('pdfCategorySelect').value;
            generatePdf(selectedCategory);
        });

        function generatePdf(category) {
            const filteredProducts = category === 'all'
                ? products
                : products.filter(product => product['Categoria'] === category);

            if (filteredProducts.length === 0) {
                alert('Não há produtos para exibir na categoria selecionada.');
                return;
            }

            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text('Catálogo de Produtos', 10, 10);

            let y = 20;
            filteredProducts.forEach(product => {
                const name = product['Produtos'];
                const stock = product['Estoque'];
                const code = product['Código'];
                const imageUrl = product['Imagem'];

                if (name) {
                    doc.setFontSize(14);
                    doc.text(name, 10, y);
                    y += 10;
                    doc.setFontSize(12);
                    doc.text(`Estoque: ${stock}`, 10, y);
                    y += 10;
                    doc.text(`Código: ${code}`, 10, y);
                    y += 10;

                    // Adiciona a imagem, se disponível
                    if (imageUrl) {
                        doc.addImage(imageUrl, 'JPEG', 10, y, 50, 30);
                        y += 40; // Ajusta a altura para a próxima seção
                    }
                }
            });

            doc.save('catalogo.pdf');
        }

        fetchData();  // Inicia a busca de dados
    </script>
</body>
</html>
