<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo de Produtos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="/manifest.json">

    
</head>
<body>
    <header>
        <img src="./Group 1.svg" alt="logo" class="logo">
    </header>

    <div class="filters" id="filters">
        <button class="print-button" onclick="window.print()">Baixar Cat√°logo</button>
        <button id="show-all">Todos</button>
        <select id="category-select">
            <option value="">Escolha uma categoria</option>
        </select>
        <select id="subcategory-select" style="display: none;">
            <option value="">Escolha uma subcategoria</option>
        </select>
    </div>
    <div class="search-container">
        <input type="text" id="search-input" placeholder="Pesquisar produto ou C√≥digo">
    </div>

    <div class="catalog-container" id="catalog-container">
        <!-- Os cards de produtos ser√£o gerados dinamicamente aqui -->
    </div>

    <div class="cart-icon" id="cart-icon">üõí <span id="cart-count" class="cart-count">0</span></div>


    <div class="cart-container" id="cart-container">
        <div class="close-cart" id="close-cart">√ó</div>
        <h2>Carrinho de Compras</h2>
        <div id="cart-items"></div>
        <div class="cart-footer">
            <div class="vendor-select">
                <select id="vendor-select">
                    <option value="">Escolha um vendedor</option>
                </select>
            </div>
            <button class="send-message-btn" id="send-message-btn">Enviar Mensagem</button>
        </div>
    </div>
    <div id="image-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index: 1000;">
        <img id="modal-image" style="max-width:90%; max-height:90%;">
    </div>
  
     
    <script>
        
        const sheetId = '1mJbjNBsfJQmhThpFvaYchuvNslHtRBPWiV7fgzONJl8';
const apiKey = 'AIzaSyBUBfQAzykuAOrdQzJHR_RTVzK0R5HhFrM';
const sheetName1 = 'Pagina1'; // Primeira p√°gina com nome, c√≥digo, etc.
const sheetName2 = 'Pagina2'; // Segunda p√°gina com c√≥digo e pre√ßo

// Especificar intervalos corretos para cada folha
const url1 = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName1}!A:Z?key=${apiKey}`;
const url2 = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName2}!A:B?key=${apiKey}`;

// Fun√ß√£o para verificar se a resposta da API cont√©m dados v√°lidos
function validateSheetData(data, sheetName) {
    if (!data || !data.values || data.values.length === 0) {
        throw new Error(`Nenhum dado encontrado na folha "${sheetName}". Verifique o nome da folha e o intervalo.`);
    }
}

// Requisi√ß√£o das duas folhas usando Promise.all
Promise.all([fetch(url1), fetch(url2)])
    .then(async (responses) => {
        // Verificar se todas as respostas s√£o bem-sucedidas
        for (let i = 0; i < responses.length; i++) {
            if (!responses[i].ok) {
                const errorText = await responses[i].text();
                throw new Error(`Erro na requisi√ß√£o para a folha ${i === 0 ? sheetName1 : sheetName2}: ${responses[i].status} - ${errorText}`);
            }
        }
        return Promise.all(responses.map(response => response.json()));
    })
    .then(([data1, data2]) => {
        // Validar os dados recebidos
        validateSheetData(data1, sheetName1);
        validateSheetData(data2, sheetName2);

        const headers1 = data1.values[0];
        const products1 = data1.values.slice(1);
        const headers2 = data2.values[0];
        const products2 = data2.values.slice(1);

        const headerIndex1 = {
            nome: headers1.indexOf('nome'),
            codigo: headers1.indexOf('codigo'),
            img: headers1.indexOf('img'),
            categoria: headers1.indexOf('categoria'),
            subcategoria: headers1.indexOf('subcategoria')
        };

        const headerIndex2 = {
            codigo: headers2.indexOf('codigo'),
            preco: headers2.indexOf('preco')
        };

        // Verificar se todas as colunas necess√°rias est√£o presentes
        if (Object.values(headerIndex1).includes(-1)) {
            throw new Error('Uma ou mais colunas necess√°rias n√£o foram encontradas na folha Pagina1.');
        }

        if (Object.values(headerIndex2).includes(-1)) {
            throw new Error('Uma ou mais colunas necess√°rias n√£o foram encontradas na folha Pagina2.');
        }

        // Mesclar produtos com base no c√≥digo
        const mergedProducts = products1.map(product1 => {
            const codigo = product1[headerIndex1.codigo];
            const matchingProduct2 = products2.find(product2 => product2[headerIndex2.codigo] === codigo);
            const preco = matchingProduct2 ? matchingProduct2[headerIndex2.preco] : 'Pre√ßo n√£o dispon√≠vel';

            return {
                ...product1,
                preco // Adiciona o pre√ßo ao produto mesclado
            };
        });

        const catalogContainer = document.getElementById('catalog-container');
        const categorySelect = document.getElementById('category-select');
        const subcategorySelect = document.getElementById('subcategory-select');
        const vendorSelect = document.getElementById('vendor-select');
        const sendMessageBtn = document.getElementById('send-message-btn');

        // Array de vendedores
        const vendors = [
            { name: 'GUSTAVO', whatsapp: '+55038998853882' },
            { name: 'GABRIEL', whatsapp: '+55038997299051' },
            // Adicione mais vendedores conforme necess√°rio
        ];

        // Preencher o seletor de vendedores
        vendors.forEach(vendor => {
            const option = document.createElement('option');
            option.value = vendor.whatsapp;
            option.textContent = vendor.name;
            vendorSelect.appendChild(option);
        });

        const categories = new Set();
        const subcategories = new Map();

        mergedProducts.forEach(product => {
            const category = product[headerIndex1.categoria];
            const subcategory = product[headerIndex1.subcategoria];

            categories.add(category);
            if (category && subcategory) {
                if (!subcategories.has(category)) {
                    subcategories.set(category, new Set());
                }
                subcategories.get(category).add(subcategory);
            }
        });

        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });

        // Adicionar a op√ß√£o "Todas as subcategorias"
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = 'Todas as subcategorias';
        subcategorySelect.appendChild(allOption);

        function updateSubcategories() {
            const selectedCategory = categorySelect.value;
            subcategorySelect.innerHTML = '<option value="">Escolha uma subcategoria</option>';

            if (selectedCategory) {
                const subcategoriesForCategory = subcategories.get(selectedCategory);
                if (subcategoriesForCategory) {
                    subcategoriesForCategory.forEach(subcategory => {
                        const option = document.createElement('option');
                        option.value = subcategory;
                        option.textContent = subcategory;
                        subcategorySelect.appendChild(option);
                    });
                }
                subcategorySelect.style.display = 'block';
            } else {
                subcategorySelect.style.display = 'none';
            }
        }

        function displayProducts(productsToDisplay) {
            catalogContainer.innerHTML = '';
            productsToDisplay.forEach(product => {
                const nome = product[headerIndex1.nome];
                const codigo = product[headerIndex1.codigo];
                const img = product[headerIndex1.img];
                const preco = product.preco;

                const card = document.createElement('div');
                card.className = 'card';

                card.innerHTML = `
                    <img src="${img}" alt="${nome}">
                    <div class="card-content">
                        <h3>${nome}</h3>
                        <p class="product-code">C√≥digo: ${codigo}</p>
                        <p class="product-price">Pre√ßo: ${preco}</p>
                        <div class="card-actions">
                            <input type="number" class="quantity-input" value="1" min="1">
                            <button class="add-to-cart-btn" data-product='${JSON.stringify(product)}'>Adicionar</button>
                        </div>
                    </div>
                `;

                catalogContainer.appendChild(card);

                // Evento para exibir imagem em modal
                card.querySelector('img').addEventListener('click', () => {
                    document.getElementById('modal-image').src = img;
                    document.getElementById('image-modal').style.display = 'flex';
                });

                // Evento para fechar o modal
                document.getElementById('image-modal').addEventListener('click', () => {
                    document.getElementById('image-modal').style.display = 'none';
                });
            });

            // Adicionar eventos aos bot√µes "Adicionar ao carrinho"
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', addToCart);
            });
        }

        // Ao carregar a p√°gina, exibir apenas os produtos da categoria "NOVIDADES"
        const noveltiesProducts = mergedProducts.filter(product => product[headerIndex1.categoria] === 'NOVIDADES');
        displayProducts(noveltiesProducts);

        function filterProducts() {
            const selectedCategory = categorySelect.value;
            const selectedSubcategory = subcategorySelect.value;

            const filteredProducts = mergedProducts.filter(product => {
                const productCategory = product[headerIndex1.categoria];
                const productSubcategory = product[headerIndex1.subcategoria];
                return (selectedCategory === '' || productCategory === selectedCategory) &&
                       (selectedSubcategory === '' || productSubcategory === selectedSubcategory);
            });

            displayProducts(filteredProducts);
        }

        const searchInput = document.getElementById('search-input');

        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();

            if (searchTerm === '') {
                catalogContainer.innerHTML = '';
                const filteredProducts = mergedProducts.filter(product => product[headerIndex1.categoria] === 'NOVIDADES');
                displayProducts(filteredProducts);
            } else {
                const filteredProducts = mergedProducts.filter(product => {
                    const productName = product[headerIndex1.nome].toLowerCase();
                    const productCode = product[headerIndex1.codigo].toLowerCase();
                    return productName.includes(searchTerm) || productCode.includes(searchTerm);
                });
                displayProducts(filteredProducts);
            }
        });

        categorySelect.addEventListener('change', () => {
            updateSubcategories();
            if (categorySelect.value) {
                filterProducts();
            } else {
                catalogContainer.innerHTML = ''; // Limpa os produtos se nenhuma categoria for selecionada
            }
        });

        subcategorySelect.addEventListener('change', filterProducts);

        // Funcionalidade do carrinho
        let cart = [];

        function addToCart(event) {
            const product = JSON.parse(event.target.getAttribute('data-product'));
            const quantity = parseInt(event.target.previousElementSibling.value);

            const existingItem = cart.find(item => item.product[headerIndex1.codigo] === product[headerIndex1.codigo]);

            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({ product, quantity });
            }

            updateCartDisplay();
            updateCartCount();
            Toastify({
                text: `Produto adicionado: ${product[headerIndex1.nome]} (Quantidade: ${quantity})`,
                duration: 3000,
                close: true,
                gravity: "top",
                position: 'right',
                backgroundColor: "#28a745",
            }).showToast();
        }

        function updateCartCount() {
            const cartCount = document.getElementById('cart-count');
            cartCount.textContent = cart.length; // Atualiza a contagem com o n√∫mero de produtos √∫nicos
        }

        function updateCartDisplay() {
            const cartItems = document.getElementById('cart-items');
            cartItems.innerHTML = '';

            cart.forEach(item => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <span>${item.product[headerIndex1.nome]} (${item.quantity})</span>
                    <button class="remove-item" data-code="${item.product[headerIndex1.codigo]}">Remover</button>
                `;
                cartItems.appendChild(cartItem);
            });

            document.querySelectorAll('.remove-item').forEach(button => {
                button.addEventListener('click', removeFromCart);
            });
        }

        function removeFromCart(event) {
            const codeToRemove = event.target.getAttribute('data-code');
            cart = cart.filter(item => item.product[headerIndex1.codigo] !== codeToRemove);
            updateCartDisplay();
            updateCartCount();
        }

        const cartIcon = document.getElementById('cart-icon');
        const cartContainer = document.getElementById('cart-container');
        const closeCart = document.getElementById('close-cart');

        cartIcon.addEventListener('click', () => {
            cartContainer.classList.add('open');
        });

        closeCart.addEventListener('click', () => {
            cartContainer.classList.remove('open');
        });

        const showAllButton = document.getElementById('show-all');
        showAllButton.addEventListener('click', () => {
            categorySelect.value = '';
            subcategorySelect.value = '';
            subcategorySelect.style.display = 'none';
            catalogContainer.innerHTML = ''; // Limpa os produtos
        });

        function sendMessage() {
            const selectedVendor = vendorSelect.value;

            if (!selectedVendor) {
                alert('Por favor, escolha um vendedor.');
                return;
            }

            if (cart.length === 0) {
                alert('O carrinho est√° vazio.');
                return;
            }

            let message = 'Ol√°, gostaria de fazer um pedido:\n\n';
            cart.forEach(item => {
                message += `‚Ä¢ (C√≥digo: ${item.product[headerIndex1.codigo]}) - Quantidade: ${item.quantity}\n`;
            });

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${selectedVendor}&text=${encodedMessage}`;

            window.open(whatsappUrl, '_blank');
        }

        sendMessageBtn.addEventListener('click', sendMessage);
    })
    .catch(error => {
        console.error('Erro ao buscar dados das planilhas:', error);
        alert(`Erro ao buscar dados das planilhas: ${error.message}`);
    });

    </script>
</body>
</html>
